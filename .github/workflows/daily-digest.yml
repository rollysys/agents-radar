name: Daily Agents Radar

on:
  schedule:
    # æ¯å¤© 00:00 UTC = 08:00 CST (UTC+8)
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  digest:
    runs-on: ubuntu-latest
    # Web content fetching adds ~60-120 s of HTTP requests on incremental runs;
    # the first-ever run (fetching 50 articles) may need up to 20 min.
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # è°ƒè¯•ï¼šæ£€æŸ¥ env æ˜¯å¦æ­£ç¡®ä¼ é€’ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
      - name: Check env vars
        run: |
          echo "ANTHROPIC_BASE_URL: ${ANTHROPIC_BASE_URL:-NOT SET}"
          echo "ANTHROPIC_API_KEY length: ${#ANTHROPIC_API_KEY}"
          echo "ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-NOT SET}"
        env:
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}

      - name: Run daily digest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Minimax Anthropic API å…¼å®¹ç«¯ç‚¹
          # URL å’Œ Model ä» Repository Variables è¯»å–ï¼ŒAPI Key ä» Secrets è¯»å–
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}
          DIGEST_REPO: ${{ github.repository }}
        run: pnpm start

      - name: Commit digest files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add digests/
          if git diff --cached --quiet; then
            echo "No new digest files to commit"
          else
            DATE=$(date -u +%Y-%m-%d)
            git commit -m "digest: ${DATE} daily digest"
            git push
          fi

      # ============ 163 é‚®ç®±å‘é€æ­¥éª¤ ============
      - name: Get current date
        if: success()
        id: date
        run: echo "DATE=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Send Email via 163
        if: success()
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.163.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "ğŸ“Š AI CLI æ—¥æŠ¥ ${{ steps.date.outputs.DATE }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>ğŸ“Š AI CLI æ—¥æŠ¥ - ${{ steps.date.outputs.DATE }}</h2>
            <p>ä»Šæ—¥ç®€æŠ¥å·²ç”Ÿæˆï¼Œè¯¦è§é™„ä»¶æˆ–è®¿é—® GitHub Issuesã€‚</p>
            <hr/>
            <p><small>æœ¬é‚®ä»¶ç”± agents-radar è‡ªåŠ¨å‘é€</small></p>
          attachments: |
            digests/${{ steps.date.outputs.DATE }}/ai-cli.md
            digests/${{ steps.date.outputs.DATE }}/ai-agents.md
            digests/${{ steps.date.outputs.DATE }}/ai-web.md
            digests/${{ steps.date.outputs.DATE }}/ai-trending.md
          secure: true
          priority: normal

      - name: Email Send Status
        if: failure()
        run: echo "âš ï¸ é‚®ä»¶å‘é€å¤±è´¥ï¼Œä½†ç®€æŠ¥å·²ç”Ÿæˆå¹¶ä¿å­˜"
